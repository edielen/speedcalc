#!/bin/bash
# bin/compile <build-dir> <cache-dir>

# fail fast
set -e

# debug ... uncomment following line to put this script in debug mode
# set -x

function error() {
  echo " !     $*" >&2
  exit 1
}

function topic() {
    YELLOW='\033[1;33m'
    RESET='\033[0m'
    echo -e "${YELLOW}===========================" | indent
    echo -e "${RESET}-----> $*" | indent
    echo -e "${YELLOW}===========================${RESET}" | indent
}

function indent() {
  c='s/^/       /'
  case $(uname) in
    Darwin) sed -l "$c";;
    *)      sed -u "$c";;
  esac
}

# initialization
topic "conda based R BuildPack"
## comment out following lines when using with real cloud foundry
# define foundation names for use in local install
BUILD_DIR=$1
export BUILD_DIR
topic "listing $BUILD_DIR"
pushd $BUILD_DIR
ls -alH
source conda_install $BUILD_DIR
popd
topic "PATH = $PATH"
export PATH=$BUILD_DIR/miniconda/envs/r_env/bin:$BUILD_DIR/miniconda/bin:$PATH
topic "new PATH = $PATH"
topic "Install complete"
